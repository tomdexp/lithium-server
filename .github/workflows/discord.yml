name: Discord notification

on:
  push:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord webhook
        run: |
          # Default message
          MESSAGE="${{ github.event_name }}"

          if [ "${{ github.event_name }}" = "push" ]; then
            # Récupérer le commit
            COMMIT_AUTHOR="${{ github.actor }}"
            COMMIT_MESSAGE=$(jq -r '.head_commit.message' <<< '${{ toJSON(github.event) }}')
            COMMIT_URL=$(jq -r '.head_commit.url' <<< '${{ toJSON(github.event) }}')
            BRANCH="${{ github.ref_name }}"
            REPO="${{ github.event.repository.name }}"

            # Construire le message selon ton format
            MESSAGE="[${COMMIT_AUTHOR}](https://github.com/${COMMIT_AUTHOR})\n[${COMMIT_MESSAGE}](${COMMIT_URL})\n\n[${COMMIT_AUTHOR}](https://github.com/${COMMIT_AUTHOR}) on [${REPO}](${{ github.server_url }}/${{ github.repository }}/tree/${BRANCH}) / ${BRANCH}"
          fi

          # Échapper les caractères spéciaux pour JSON
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | jq -Rs .)

          # Envoyer le webhook
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"${{ github.actor }}\",
              \"avatar_url\": \"https://github.com/${{ github.actor }}.png\",
              \"content\": ${MESSAGE_ESCAPED}
            }"