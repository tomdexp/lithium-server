using System.Buffers;
using Microsoft.Extensions.DependencyInjection;

namespace Lithium.Codecs.Tests.Generated;

public class GeneratedCodecTests
{
    [Fact]
    public void GeneratedPersonCodec_ShouldEncodeAndDecode()
    {
        // Arrange
        var services = new ServiceCollection();
        services.AddLithiumCodecs();

        // Extension generated by the codec source generator
        services.AddPersonCodec();

        var serviceProvider = services.BuildServiceProvider();
        var registry = serviceProvider.GetRequiredService<ICodecRegistry>();

        var person = new Person
        {
            Name = "John Doe",
            Age = 42
        };

        var codec = registry.Get<Person>();
        var bufferWriter = new ArrayBufferWriter<byte>();

        // Act
        codec.Encode(person, bufferWriter);
        
        var sequence = new ReadOnlySequence<byte>(bufferWriter.WrittenMemory);
        var reader = new SequenceReader<byte>(sequence);
        var decoded = codec.Decode(ref reader);

        // Assert
        Assert.NotNull(decoded);
        Assert.Equal(person.Name, decoded.Name);
        Assert.Equal(person.Age, decoded.Age);
        Assert.IsType<PersonCodec>(codec);
    }
}